<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans&display=swap" rel="stylesheet"> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/viewAuctionItem.css"> 
</head>
<body>
    <div class="container">
        <div class="product"> 
            <div class="product-image">
                <img id="itemImage">
            </div>
            <div class="product-details">
                <h1 id="itemName"></h2>
                <p id="itemDescription"></p>
                <p id="currentBid">Current bid: </p>
                <form>
                    <input type="number" name="currentBid" placeholder="0 kr">
                    <button type="submit" id="submitBidButton">Legg til bud</button>
                </form>
            </div>
        </div>


    </div>
    <!-- <div class="header">
        <h1>Auksjonsobjekt</h1>
        <p id="currentBid">Current bid: </p>
        <form>
            <input type="number" name="currentBid" placeholder="0 kr">
            <button type="submit" id="submitBidButton">Legg til bud</button>
        </form>
    </div>

    <div class="auction-item">
        <div class="item-image">
            <img id="itemImage" src="" alt="Item Image">
        </div>
        <div class="item-details">
            <h2 id="itemName"></h2>
            <p id="itemDescription"></p>
            <p id="itemCurrentBid"></p>
        </div>
    </div> -->

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDC_yGwhnlgbRTLdvvSJkNi-FGFZgzUKuk",
            authDomain: "omegaauctionen.firebaseapp.com",
            databaseURL: "https://omegaauctionen-default-rtdb.firebaseio.com",
            projectId: "omegaauctionen",
            storageBucket: "omegaauctionen.appspot.com",
            messagingSenderId: "612432199946",
            appId: "1:612432199946:web:8475ac11c820c11d5c3af3",
            measurementId: "G-NLP4T6TXHL"
        };

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        // Get the value of the id parameter
        const itemId = urlParams.get('itemId');
        
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        const auctionItemsRef = db.collection("auctionItems");

        
        function getItemData() {
            const auctionItemRef = auctionItemsRef.doc(itemId);
            auctionItemRef.get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('currentBid').textContent = "Current bid: " + data.currentPrice + " kr";
                    document.getElementById('itemName').textContent = data.itemName;
                    document.getElementById('itemDescription').textContent = data.description;
                    document.getElementById('itemImage').src = data.imageURL;
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.error("Error getting document:", error);
            });
        }

        getItemData();

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
            // User is signed in
            console.log("User is logged in:", user);
            } else {
            // No user is signed in
            console.log("User is not logged in.");
            }
        });

        function getUserId() {
            const user = firebase.auth().currentUser;
            if (user) {
                console.log("User ID:", user.uid);
                return user.uid;
            } else {
                return null;
            }
        }

        function updateBid() {
            const submitBidButton = document.getElementById('submitBidButton');
            const currentBid = parseFloat(document.querySelector('input[name="currentBid"]').value);
            const user = firebase.auth().currentUser;
            const userId = user.uid;
            const userRef = db.collection("users").doc(userId);
            const auctionItemRef = auctionItemsRef.doc(itemId);
            auctionItemRef.get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const currentPrice = data.currentPrice;
                    console.log("Current price:", currentPrice);
                    if (currentBid > currentPrice) {
                        auctionItemRef.update({
                            currentPrice: currentBid,
                            highestBidder: userId
                        }).then(() => {
                            console.log("Document successfully updated!");
                            userRef.update({
                                currentBids: firebase.firestore.FieldValue.arrayUnion(itemId)
                            }).then(() => {
                                console.log("Document successfully updated!");
                            }).catch((error) => {
                                console.error("Error updating document: ", error);
                            });
                        }).catch((error) => {
                            console.error("Error updating document: ", error);
                        });
                    } else {
                        console.log("The bid is too low");
                    }
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.error("Error getting document:", error);
            });
        }

        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();
            updateBid();
        });


        
    </script>
</body>
</html>