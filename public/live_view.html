<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans&display=swap" rel="stylesheet"> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/data_view.css"> 
</head>
<body>
    
    <h1>DATA JIPPI</h1>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <!-- <script src="/node_modules/chart.js/dist/chart.umd.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> -->

    <canvas id="biggestSpenderChart" style="width:100%;max-width:700px"></canvas>
    <canvas id="classSpenderChart" style="width:100%;max-width:700px"></canvas>

    <script>
        // TODO: stretch goals
        const biggestSpenderChart = new Chart("biggestSpenderChart", {
            type: "doughnut",
            data: {
                labels: [
                    'Red',
                    'Blue',
                    'Yellow'
                ],
                datasets: [{
                    label: 'My First Dataset',
                    data: [300, 50, 100],
                    backgroundColor: [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {}
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyDC_yGwhnlgbRTLdvvSJkNi-FGFZgzUKuk",
                authDomain: "omegaauctionen.firebaseapp.com",
                databaseURL: "https://omegaauctionen-default-rtdb.firebaseio.com",
                projectId: "omegaauctionen",
                storageBucket: "omegaauctionen.appspot.com",
                messagingSenderId: "612432199946",
                appId: "1:612432199946:web:8475ac11c820c11d5c3af3",
                measurementId: "G-NLP4T6TXHL"
            };
            
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore(app);
            const itemsRef = db.collection("auctionItems");
            const usersRef = db.collection("users");

            let p = document.getElementById("view");
            
            let data = [];
            let labels = [];

            let colors = [
                'rgb(255, 99, 132)',
                'rgb(211, 92, 229)',
                'rgb(54, 162, 235)',
                'rgb(75, 192, 192)',
                'rgb(255, 205, 86)',
                'rgb(201, 203, 207)',
            ];

            let spenders = {}

            const updateData = async (auctionItemDoc) => {
                try {
                    const userDoc = await usersRef.doc(auctionItemDoc.data().highestBidder).get();

                    if (userDoc.exists) {
                        const fullName = `${userDoc.data().firstname} ${userDoc.data().lastname}`;

                        if (spenders[fullName] === undefined) {
                            spenders[fullName] = auctionItemDoc.data().currentPrice;
                        } else {
                            spenders[fullName] += auctionItemDoc.data().currentPrice;
                        }

                        // data.push(auctionItemDoc.data().currentPrice);
                    } else {
                        console.log("user not foun");
                    }   
                } catch (error) {
                    console.error("Error updating data: ", error);
                }
            };

            const getChartData = async () => {
                let entries = Object
                    .entries(spenders)                
                    .map((val, _i, _arr) => { return [val[0], Number(val[1])]; })
                    .sort((a, b) => { return b[1] - a[1]; });

                data[5] = 0;
                entries.forEach((entry, index, _arr) => {
                    if (index < 5) {
                        console.log(entry[0]);

                        data[index] = entry[1];
                        labels[index] = entry[0];
                    } else {
                        data[5] += entry[1];
                        labels[5] = 'other';
                    }
                });
            }

            try {
                const querySnapshot = await itemsRef.get();
                const promises = [];
                querySnapshot.forEach((doc) => {
                    promises.push(updateData(doc));
                });
                await Promise.all(promises);
                getChartData();
                console.log(data);
                biggestSpenderChart.data.datasets[0].data = data;
                biggestSpenderChart.data.datasets[0].backgroundColor = colors;
                biggestSpenderChart.data.labels = labels;
                biggestSpenderChart.update();
                console.log(spenders);

            } catch (error) {
                console.error("Error fetching data: ", error);
            }
        });
</script>
</body>
</html>